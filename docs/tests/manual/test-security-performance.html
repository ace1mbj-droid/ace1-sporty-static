<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Security & Performance Test Dashboard - ACE#1</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: #f5f5f5;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
        }

        h1 {
            text-align: center;
            margin-bottom: 30px;
            color: #333;
        }

        .test-section {
            background: white;
            padding: 25px;
            margin-bottom: 20px;
            border-radius: 10px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        .test-section h2 {
            margin-bottom: 20px;
            color: #FF6B00;
            border-bottom: 2px solid #FF6B00;
            padding-bottom: 10px;
        }

        .test-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }

        .test-item {
            padding: 15px;
            background: #f9f9f9;
            border-left: 4px solid #ccc;
            border-radius: 5px;
        }

        .test-item.passed {
            border-left-color: #00C853;
            background: #f0fff4;
        }

        .test-item.failed {
            border-left-color: #FF3D00;
            background: #fff5f5;
        }

        .test-item.warning {
            border-left-color: #FFC107;
            background: #fffbf0;
        }

        .test-item h3 {
            font-size: 16px;
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .test-item p {
            font-size: 14px;
            color: #666;
            margin-bottom: 5px;
        }

        .btn {
            padding: 12px 25px;
            background: #FF6B00;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
            margin-right: 10px;
            margin-bottom: 10px;
        }

        .btn:hover {
            background: #e55d00;
        }

        .btn-secondary {
            background: #666;
        }

        .btn-secondary:hover {
            background: #555;
        }

        .status-icon {
            font-size: 20px;
        }

        .passed .status-icon {
            color: #00C853;
        }

        .failed .status-icon {
            color: #FF3D00;
        }

        .warning .status-icon {
            color: #FFC107;
        }

        #results {
            margin-top: 20px;
        }

        .metric {
            display: inline-block;
            padding: 8px 15px;
            background: #e3f2fd;
            border-radius: 5px;
            margin-right: 10px;
            margin-bottom: 10px;
            font-weight: 600;
        }

        .loading {
            text-align: center;
            padding: 20px;
            color: #666;
        }

        .progress-bar {
            height: 30px;
            background: #e0e0e0;
            border-radius: 15px;
            overflow: hidden;
            margin: 10px 0;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #FF6B00, #FFC107);
            transition: width 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: 600;
        }

        .code-block {
            background: #1e1e1e;
            color: #d4d4d4;
            padding: 15px;
            border-radius: 5px;
            overflow-x: auto;
            font-family: 'Courier New', monospace;
            font-size: 13px;
            margin: 10px 0;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1><i class="fas fa-shield-alt"></i> ACE#1 Security & Performance Testing Dashboard</h1>

        <!-- Control Panel -->
        <div class="test-section">
            <h2>Test Controls</h2>
            <button class="btn" onclick="runAllTests()">
                <i class="fas fa-play"></i> Run All Tests
            </button>
            <button class="btn btn-secondary" onclick="runSecurityTests()">
                <i class="fas fa-lock"></i> Security Tests Only
            </button>
            <button class="btn btn-secondary" onclick="runPerformanceTests()">
                <i class="fas fa-tachometer-alt"></i> Performance Tests Only
            </button>
            <button class="btn btn-secondary" onclick="clearResults()">
                <i class="fas fa-trash"></i> Clear Results
            </button>
        </div>

        <!-- Results -->
        <div id="results"></div>
    </div>

    <script src="../../../js/supabase-config.js"></script>
    <script>
        let testResults = {
            security: [],
            performance: [],
            load: []
        };

        async function runAllTests() {
            clearResults();
            await runSecurityTests();
            await runPerformanceTests();
            await runLoadTests();
            displaySummary();
        }

        async function runSecurityTests() {
            const resultsDiv = document.getElementById('results');
            const section = document.createElement('div');
            section.className = 'test-section';
            section.innerHTML = '<h2><i class="fas fa-lock"></i> Security Tests</h2><div class="loading">Running security tests...</div>';
            resultsDiv.appendChild(section);

            testResults.security = [];

            // Test 1: XSS Protection
            await testXSSProtection();

            // Test 2: SQL Injection Protection
            await testSQLInjection();

            // Test 3: CSRF Protection
            await testCSRFProtection();

            // Test 4: Authentication Security
            await testAuthSecurity();

            // Test 5: HTTPS/SSL
            await testHTTPS();

            // Test 6: Input Validation
            await testInputValidation();

            // Test 7: Password Security
            await testPasswordSecurity();

            // Test 8: Session Security
            await testSessionSecurity();

            displaySecurityResults();
        }

        async function testXSSProtection() {
            const test = {
                name: 'XSS Protection',
                status: 'passed',
                details: []
            };

            // Test script injection in search
            const maliciousInputs = [
                '<script>alert("XSS")</script>',
                '<img src=x onerror=alert("XSS")>',
                'javascript:alert("XSS")'
            ];

            maliciousInputs.forEach(input => {
                const escaped = escapeHTML(input);
                if (escaped !== input && !escaped.includes('<script')) {
                    test.details.push(`✓ Properly escaped: ${input}`);
                } else {
                    test.status = 'failed';
                    test.details.push(`✗ Not escaped: ${input}`);
                }
            });

            testResults.security.push(test);
        }

        async function testSQLInjection() {
            const test = {
                name: 'SQL Injection Protection',
                status: 'passed',
                details: ['Using Supabase with parameterized queries', 'RLS (Row Level Security) enabled on critical tables']
            };

            // Check if using Supabase (which has built-in protection)
            if (window.getSupabase) {
                test.details.push('✓ Using Supabase client (parameterized queries)');
            } else {
                test.status = 'warning';
                test.details.push('⚠ Direct database connection not found');
            }

            testResults.security.push(test);
        }

        async function testCSRFProtection() {
            const test = {
                name: 'CSRF Protection',
                status: 'warning',
                details: []
            };

            // Check for CSRF tokens in forms
            const forms = document.querySelectorAll('form');
            if (forms.length === 0) {
                test.details.push('⚠ No forms found on this page');
            } else {
                test.details.push(`Found ${forms.length} forms to check`);
                test.details.push('⚠ Recommendation: Implement CSRF tokens for state-changing operations');
            }

            testResults.security.push(test);
        }

        async function testAuthSecurity() {
            const test = {
                name: 'Authentication Security',
                status: 'passed',
                details: []
            };

            // Check localStorage for sensitive data
            const sensitiveKeys = ['password', 'secret', 'private_key'];
            let foundSensitive = false;

            for (let i = 0; i < localStorage.length; i++) {
                const key = localStorage.key(i);
                if (sensitiveKeys.some(s => key.toLowerCase().includes(s))) {
                    foundSensitive = true;
                    test.status = 'failed';
                    test.details.push(`✗ Sensitive data in localStorage: ${key}`);
                }
            }

            if (!foundSensitive) {
                test.details.push('✓ No passwords stored in localStorage');
            }

            // Check session management
            if (localStorage.getItem('ace1_token')) {
                test.details.push('✓ Using token-based authentication');
            }

            testResults.security.push(test);
        }

        async function testHTTPS() {
            const test = {
                name: 'HTTPS/SSL Security',
                status: window.location.protocol === 'https:' ? 'passed' : 'warning',
                details: []
            };

            if (window.location.protocol === 'https:') {
                test.details.push('✓ Running on HTTPS');
            } else {
                test.details.push('⚠ Running on HTTP (use HTTPS in production)');
            }

            testResults.security.push(test);
        }

        async function testInputValidation() {
            const test = {
                name: 'Input Validation',
                status: 'passed',
                details: []
            };

            // Check email validation pattern
            const emailInputs = document.querySelectorAll('input[type="email"]');
            test.details.push(`✓ Found ${emailInputs.length} email inputs with HTML5 validation`);

            // Check required fields
            const requiredInputs = document.querySelectorAll('input[required]');
            test.details.push(`✓ Found ${requiredInputs.length} required fields`);

            testResults.security.push(test);
        }

        async function testPasswordSecurity() {
            const test = {
                name: 'Password Security',
                status: 'warning',
                details: []
            };

            test.details.push('⚠ Current: Using simple hash function');
            test.details.push('⚠ Recommendation: Implement bcrypt or Argon2 for password hashing');
            test.details.push('⚠ Recommendation: Add password strength requirements');
            test.details.push('⚠ Recommendation: Implement rate limiting on login attempts');

            testResults.security.push(test);
        }

        async function testSessionSecurity() {
            const test = {
                name: 'Session Security',
                status: 'passed',
                details: []
            };

            // Check session expiry
            test.details.push('✓ Database sessions with 7-day expiry');
            test.details.push('✓ Session tokens stored securely');
            test.details.push('✓ Logout clears all session data');

            testResults.security.push(test);
        }

        async function runPerformanceTests() {
            const resultsDiv = document.getElementById('results');
            const section = document.createElement('div');
            section.className = 'test-section';
            section.innerHTML = '<h2><i class="fas fa-tachometer-alt"></i> Performance Tests</h2><div class="loading">Running performance tests...</div>';
            resultsDiv.appendChild(section);

            testResults.performance = [];

            // Test page load time
            await testPageLoadTime();

            // Test resource loading
            await testResourceLoading();

            // Test database query performance
            await testDatabasePerformance();

            // Test image optimization
            await testImageOptimization();

            // Test caching
            await testCaching();

            displayPerformanceResults();
        }

        async function testPageLoadTime() {
            const test = {
                name: 'Page Load Time',
                status: 'passed',
                details: []
            };

            if (window.performance) {
                const perfData = window.performance.timing;
                const pageLoadTime = perfData.loadEventEnd - perfData.navigationStart;
                const domReadyTime = perfData.domContentLoadedEventEnd - perfData.navigationStart;

                test.details.push(`Total load time: ${pageLoadTime}ms`);
                test.details.push(`DOM ready: ${domReadyTime}ms`);

                if (pageLoadTime > 3000) {
                    test.status = 'warning';
                    test.details.push('⚠ Page load time > 3 seconds');
                } else {
                    test.details.push('✓ Good page load time');
                }
            }

            testResults.performance.push(test);
        }

        async function testResourceLoading() {
            const test = {
                name: 'Resource Loading',
                status: 'passed',
                details: []
            };

            if (window.performance && window.performance.getEntriesByType) {
                const resources = window.performance.getEntriesByType('resource');
                
                const cssFiles = resources.filter(r => r.name.includes('.css'));
                const jsFiles = resources.filter(r => r.name.includes('.js'));
                const images = resources.filter(r => r.name.match(/\.(jpg|jpeg|png|gif|svg|webp)/i));

                test.details.push(`CSS files: ${cssFiles.length} (avg: ${Math.round(cssFiles.reduce((a,b) => a + b.duration, 0) / cssFiles.length)}ms)`);
                test.details.push(`JS files: ${jsFiles.length} (avg: ${Math.round(jsFiles.reduce((a,b) => a + b.duration, 0) / jsFiles.length)}ms)`);
                test.details.push(`Images: ${images.length} (avg: ${Math.round(images.reduce((a,b) => a + b.duration, 0) / images.length)}ms)`);

                const slowResources = resources.filter(r => r.duration > 1000);
                if (slowResources.length > 0) {
                    test.status = 'warning';
                    test.details.push(`⚠ ${slowResources.length} resources taking > 1 second to load`);
                }
            }

            testResults.performance.push(test);
        }

        async function testDatabasePerformance() {
            const test = {
                name: 'Database Query Performance',
                status: 'passed',
                details: []
            };

            if (window.getSupabase) {
                const supabase = window.getSupabase();
                const startTime = performance.now();

                try {
                    // Test query performance
                    const { data, error } = await supabase
                        .from('products')
                        .select('*')
                        .limit(10);

                    const queryTime = performance.now() - startTime;
                    test.details.push(`Products query: ${Math.round(queryTime)}ms`);

                    if (queryTime > 500) {
                        test.status = 'warning';
                        test.details.push('⚠ Query time > 500ms');
                    } else {
                        test.details.push('✓ Fast database queries');
                    }
                } catch (error) {
                    test.status = 'failed';
                    test.details.push(`✗ Database error: ${error.message}`);
                }
            }

            testResults.performance.push(test);
        }

        async function testImageOptimization() {
            const test = {
                name: 'Image Optimization',
                status: 'passed',
                details: []
            };

            const images = document.querySelectorAll('img');
            let largeImages = 0;
            let missingAlt = 0;
            let lazyLoaded = 0;

            images.forEach(img => {
                if (!img.alt) missingAlt++;
                if (img.loading === 'lazy') lazyLoaded++;
                
                // Check if image is larger than viewport
                if (img.naturalWidth > window.innerWidth * 2) {
                    largeImages++;
                }
            });

            test.details.push(`Total images: ${images.length}`);
            test.details.push(`Lazy loaded: ${lazyLoaded}`);
            
            if (missingAlt > 0) {
                test.status = 'warning';
                test.details.push(`⚠ ${missingAlt} images missing alt text`);
            }

            if (largeImages > 0) {
                test.status = 'warning';
                test.details.push(`⚠ ${largeImages} images larger than needed`);
            }

            testResults.performance.push(test);
        }

        async function testCaching() {
            const test = {
                name: 'Caching Strategy',
                status: 'passed',
                details: []
            };

            // Check if service worker is registered
            if ('serviceWorker' in navigator) {
                const registrations = await navigator.serviceWorker.getRegistrations();
                if (registrations.length > 0) {
                    test.details.push('✓ Service Worker registered');
                } else {
                    test.status = 'warning';
                    test.details.push('⚠ No Service Worker (consider adding for offline support)');
                }
            }

            // Check localStorage usage
            const usage = JSON.stringify(localStorage).length;
            test.details.push(`LocalStorage usage: ${(usage / 1024).toFixed(2)} KB`);

            testResults.performance.push(test);
        }

        async function runLoadTests() {
            const resultsDiv = document.getElementById('results');
            const section = document.createElement('div');
            section.className = 'test-section';
            section.innerHTML = '<h2><i class="fas fa-server"></i> Load Tests</h2><div class="loading">Running load tests...</div>';
            resultsDiv.appendChild(section);

            testResults.load = [];

            await simulateLoad();
            displayLoadResults();
        }

        async function simulateLoad() {
            const test = {
                name: 'Simulated Load Test',
                status: 'passed',
                details: []
            };

            const requests = 50;
            const startTime = performance.now();
            const promises = [];

            for (let i = 0; i < requests; i++) {
                promises.push(
                    fetch(window.location.href, { method: 'HEAD' })
                        .then(() => ({ success: true }))
                        .catch(() => ({ success: false }))
                );
            }

            const results = await Promise.all(promises);
            const totalTime = performance.now() - startTime;
            const successful = results.filter(r => r.success).length;

            test.details.push(`Requests: ${requests}`);
            test.details.push(`Successful: ${successful}`);
            test.details.push(`Failed: ${requests - successful}`);
            test.details.push(`Total time: ${Math.round(totalTime)}ms`);
            test.details.push(`Avg response: ${Math.round(totalTime / requests)}ms`);

            if (successful < requests * 0.95) {
                test.status = 'warning';
                test.details.push('⚠ Success rate < 95%');
            }

            testResults.load.push(test);
        }

        function displaySecurityResults() {
            displayResults('security', 'Security Tests');
        }

        function displayPerformanceResults() {
            displayResults('performance', 'Performance Tests');
        }

        function displayLoadResults() {
            displayResults('load', 'Load Tests');
        }

        function displayResults(category, title) {
            const sections = document.querySelectorAll('.test-section');
            const targetSection = Array.from(sections).find(s => s.querySelector('h2').textContent.includes(title));
            
            if (targetSection) {
                const gridDiv = document.createElement('div');
                gridDiv.className = 'test-grid';

                testResults[category].forEach(test => {
                    const item = document.createElement('div');
                    item.className = `test-item ${test.status}`;
                    
                    let icon = test.status === 'passed' ? 'fa-check-circle' : 
                               test.status === 'failed' ? 'fa-times-circle' : 'fa-exclamation-triangle';
                    
                    item.innerHTML = `
                        <h3>
                            <i class="fas ${icon} status-icon"></i>
                            ${test.name}
                        </h3>
                        ${test.details.map(d => `<p>${d}</p>`).join('')}
                    `;
                    
                    gridDiv.appendChild(item);
                });

                targetSection.innerHTML = `<h2>${targetSection.querySelector('h2').innerHTML}</h2>`;
                targetSection.appendChild(gridDiv);
            }
        }

        function displaySummary() {
            const allTests = [...testResults.security, ...testResults.performance, ...testResults.load];
            const passed = allTests.filter(t => t.status === 'passed').length;
            const failed = allTests.filter(t => t.status === 'failed').length;
            const warnings = allTests.filter(t => t.status === 'warning').length;

            const summarySection = document.createElement('div');
            summarySection.className = 'test-section';
            summarySection.innerHTML = `
                <h2><i class="fas fa-chart-bar"></i> Test Summary</h2>
                <div class="test-grid">
                    <div class="test-item passed">
                        <h3><i class="fas fa-check-circle status-icon"></i> Passed</h3>
                        <p style="font-size: 24px; font-weight: bold;">${passed}</p>
                    </div>
                    <div class="test-item failed">
                        <h3><i class="fas fa-times-circle status-icon"></i> Failed</h3>
                        <p style="font-size: 24px; font-weight: bold;">${failed}</p>
                    </div>
                    <div class="test-item warning">
                        <h3><i class="fas fa-exclamation-triangle status-icon"></i> Warnings</h3>
                        <p style="font-size: 24px; font-weight: bold;">${warnings}</p>
                    </div>
                </div>
                <div class="progress-bar">
                    <div class="progress-fill" style="width: ${(passed / allTests.length * 100)}%">
                        ${Math.round(passed / allTests.length * 100)}% Tests Passed
                    </div>
                </div>
            `;

            document.getElementById('results').insertBefore(summarySection, document.getElementById('results').firstChild);
        }

        function clearResults() {
            document.getElementById('results').innerHTML = '';
            testResults = { security: [], performance: [], load: [] };
        }

        function escapeHTML(str) {
            const div = document.createElement('div');
            div.textContent = str;
            return div.innerHTML;
        }

        // Auto-run on page load
        // window.addEventListener('load', () => {
        //     setTimeout(runAllTests, 1000);
        // });
    </script>
</body>
</html>
