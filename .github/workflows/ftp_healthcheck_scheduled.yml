name: FTP health-check (scheduled)

on:
  # Temporarily disabling scheduled runs; manual dispatch only
  workflow_dispatch:
    inputs:
      allowed_status_codes:
        description: 'Comma-separated HTTP codes treated as healthy'
        required: false
        default: '200,301,302,403'

jobs:
  healthcheck:
    runs-on: ubuntu-latest
    env:
      FTP_HOST: ${{ secrets.FTP_HOST }}
      FTP_USER: ${{ secrets.FTP_USER }}
      FTP_PASSWORD: ${{ secrets.FTP_PASSWORD }}
      FTP_PORT: 21
      DOMAIN: ${{ secrets.SITE_DOMAIN }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install tools
        run: |
          sudo apt-get update -y
          sudo apt-get install -y lftp curl

      - name: Initial site HEAD check
        run: |
          if [ -z "$DOMAIN" ]; then echo "SITE_DOMAIN secret not set"; exit 0; fi
          echo "HEAD -> https://$DOMAIN"
          code=$(curl -s -o /dev/null -w "%{http_code}" -I "https://$DOMAIN" || echo 000)
          echo "Initial HTTP status: $code"
          ALLOWED="${{ github.event.inputs.allowed_status_codes }}"
          if [ -z "$ALLOWED" ]; then ALLOWED="200,301,302,403"; fi
          echo "Allowed status codes: $ALLOWED"
          PASS=false
          IFS=',' read -ra CODES <<< "$ALLOWED"
          for candidate in "${CODES[@]}"; do
            CLEAN_CODE=$(echo "$candidate" | xargs)
            if [ "$code" = "$CLEAN_CODE" ]; then
              PASS=true
              break
            fi
          done
          if [ "$PASS" = true ]; then
            echo "Status $code is allowed"
          else
            echo "Status $code not in allowed list"
            exit 1
          fi

      - name: Verbose headers (HEAD and GET)
        run: |
          curl -svI "https://$DOMAIN" -H "User-Agent: Mozilla/5.0" -o /dev/null 2>&1 | sed -n 's/^< \(Server\|Via\|CF-\|X-\)/\0/p'
          curl -sv "https://$DOMAIN" -H "User-Agent: Mozilla/5.0" -o /dev/null 2>&1 | sed -n 's/^< \(Server\|Via\|CF-\|X-\)/\0/p'

      - name: List remote root (confirm index.html exists)
        run: |
          TARGET="ftp://$FTP_HOST"; FLAGS="set ftp:ssl-force true; set ftp:ssl-protect-data true; set ssl:verify-certificate false;"
          echo "Listing / (top 50 entries)"
          lftp -u "$FTP_USER,$FTP_PASSWORD" -p "$FTP_PORT" "$TARGET" -e "$FLAGS cls -l / | head -50; bye" || true
