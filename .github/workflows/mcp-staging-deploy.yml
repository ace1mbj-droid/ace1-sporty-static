name: MCP Deploy (staging-only)

on:
  workflow_dispatch: {}
  push:
    branches: [ staging ]

jobs:
  mcp-deploy-staging:
    name: Run MCP migrations & deploy functions (staging-only)
    runs-on: ubuntu-latest
    env:
      # These must be added to the repository (or org) secrets for a safe run
      SUPABASE_PROJECT_REF: ${{ secrets.SUPABASE_PROJECT_REF_STAGING }}
      SUPABASE_URL: ${{ secrets.SUPABASE_URL_STAGING }}
      SUPABASE_SERVICE_ROLE_KEY: ${{ secrets.SUPABASE_SERVICE_ROLE_KEY_STAGING }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Use Node
        uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: Verify secrets exist
        run: |
          if [ -z "$SUPABASE_PROJECT_REF" ] || [ -z "$SUPABASE_URL" ] || [ -z "$SUPABASE_SERVICE_ROLE_KEY" ]; then
            echo "Missing required Supabase staging secrets. Set SUPABASE_PROJECT_REF_STAGING, SUPABASE_URL_STAGING and SUPABASE_SERVICE_ROLE_KEY_STAGING in repo secrets.";
            exit 1;
          fi

      - name: Verify MCP access (dry-run check)
        run: |
          echo "Verifying MCP connection and permissions..."
          if ! curl -f -H "Authorization: Bearer $SUPABASE_SERVICE_ROLE_KEY" "https://mcp.supabase.com/mcp?project_ref=$SUPABASE_PROJECT_REF&features=docs,account,database,debugging,development,functions,storage,branching" > /dev/null 2>&1; then
            echo "⚠️  MCP verification endpoint returned an error - this may be expected."
            echo "Continuing with deployment. If MCP commands fail, check SUPABASE_SERVICE_ROLE_KEY_STAGING secret."
          else
            echo "✅ MCP access verified successfully."
          fi

      - name: Run MCP:DB (apply migrations) — safe, staging-only
        run: |
          npx -y @supabase/mcp-server-supabase@0.5.9 --project-ref "$SUPABASE_PROJECT_REF" --api-url "$SUPABASE_URL" --SUPABASE_SERVICE_ROLE_KEY "$SUPABASE_SERVICE_ROLE_KEY" deploy:db

      - name: Run MCP:functions (deploy edge functions)
        run: |
          npx -y @supabase/mcp-server-supabase@0.5.9 --project-ref "$SUPABASE_PROJECT_REF" --api-url "$SUPABASE_URL" --SUPABASE_SERVICE_ROLE_KEY "$SUPABASE_SERVICE_ROLE_KEY" deploy:functions || echo "Function deploy may be skipped if no functions found."

      - name: Post-run guidance
        run: |
          echo "MCP staging deploy steps finished. The workflow is intentionally limited to the 'staging' branch and workflow_dispatch to avoid accidental production runs. Use short-lived/service-role secrets and rotate keys if they are compromised."
