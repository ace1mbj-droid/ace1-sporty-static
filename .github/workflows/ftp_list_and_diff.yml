name: FTPS List and Diff (manual)

on:
  workflow_dispatch:
    inputs:
      remote_dir:
        description: 'Remote directory to inspect'
        required: true
        default: '/public_html'
      use_ftps:
        description: 'Use FTPS (TLS)'
        required: true
        default: 'true'

jobs:
  list-diff:
    runs-on: ubuntu-latest
    env:
      FTP_HOST: ${{ secrets.FTP_HOST }}
      FTP_USER: ${{ secrets.FTP_USER }}
      FTP_PASSWORD: ${{ secrets.FTP_PASSWORD }}
      FTP_PORT: 990
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install tools
        run: |
          sudo apt-get update -y
          sudo apt-get install -y lftp

      - name: Set inputs
        run: |
          echo "REMOTE_DIR=${{ github.event.inputs.remote_dir }}" >> $GITHUB_ENV
          echo "USE_FTPS=${{ github.event.inputs.use_ftps }}" >> $GITHUB_ENV

      - name: List remote with perms (top 200)
        run: |
          if [ "$USE_FTPS" = "true" ]; then
            TARGET="ftps://$FTP_HOST"; FLAGS="set ftp:ssl-force true; set ftp:ssl-protect-data true; set ssl:verify-certificate false; set ftps:initial-prot '';"
          else
            TARGET="ftp://$FTP_HOST"; FLAGS=""
          fi
          echo "Listing $REMOTE_DIR"
          lftp -u "$FTP_USER,$FTP_PASSWORD" -p "$FTP_PORT" "$TARGET" -e "$FLAGS cls -l $REMOTE_DIR | head -200; bye" || true

      - name: Diff local vs remote file names (shallow)
        run: |
          if [ "$USE_FTPS" = "true" ]; then
            TARGET="ftps://$FTP_HOST"; FLAGS="set ftp:ssl-force true; set ftp:ssl-protect-data true; set ssl:verify-certificate false; set ftps:initial-prot '';"
          else
            TARGET="ftp://$FTP_HOST"; FLAGS=""
          fi
          echo "Collect remote names"
          lftp -u "$FTP_USER,$FTP_PASSWORD" -p "$FTP_PORT" "$TARGET" -e "$FLAGS find $REMOTE_DIR; bye" | sed "s#^$REMOTE_DIR/##" | sort > remote.txt || true
          echo "Collect local names"
          git ls-files | sort > local.txt
          echo "--- Missing on remote ---"
          comm -23 local.txt remote.txt | head -200 || true
          echo "--- Extra on remote ---"
          comm -13 local.txt remote.txt | head -200 || true
