name: FTPS Server Prune (manual)

on:
  workflow_dispatch:
    inputs:
      remote_dir:
        description: 'Remote root to prune'
        required: true
        default: '/public_html'

jobs:
  prune:
    runs-on: ubuntu-latest
    env:
      FTP_HOST: ${{ secrets.FTP_HOST }}
      FTP_USER: ${{ secrets.FTP_USER }}
      FTP_PASSWORD: ${{ secrets.FTP_PASSWORD }}
      FTP_PORT: 21
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install lftp
        run: |
          sudo apt-get update -y
          sudo apt-get install -y lftp

      - name: Prune non-whitelisted files from remote
        run: |
          set -euo pipefail
          TARGET_DIR="${{ github.event.inputs.remote_dir }}"
          if [ -z "$TARGET_DIR" ]; then TARGET_DIR="/public_html"; fi
          echo "Pruning $TARGET_DIR on $FTP_HOST"

          TMP_ALL=$(mktemp)
          TMP_DELETE=$(mktemp)
          cleanup() { rm -f "$TMP_ALL" "$TMP_DELETE"; }
          trap cleanup EXIT

          # Pull remote listing into a local temp file (ignore 550 warnings about missing folders)
          if ! lftp -u "$FTP_USER,$FTP_PASSWORD" -p "$FTP_PORT" "ftp://$FTP_HOST" -e "set ftp:ssl-force true; set ftp:ssl-protect-data true; set ftp:ssl-auth TLS; set ssl:verify-certificate false; set ftps:initial-prot C; set cmd:fail-exit false; find -l $TARGET_DIR; bye" > "$TMP_ALL"; then
            echo "Remote find returned warnings (continuing with available listing)"
          fi

          # Determine deletion candidates locally (anything not matching the allow-list)
          awk '{print $NF}' "$TMP_ALL" \
            | grep -vE '(\.html$|\.css$|\.js$|\.json$|\.ico$|\.map$|\.png$|\.jpg$|\.jpeg$|\.gif$|\.svg$|\.webp$|\.avif$|\.woff$|\.woff2$|\.ttf$|\.otf$|\.eot$)$' \
            | grep -v '/$' \
            > "$TMP_DELETE" || true

          if [ ! -s "$TMP_DELETE" ]; then
            echo "No files to prune"
            exit 0
          fi

          echo "Will remove:" && head -200 "$TMP_DELETE"

          {
            echo "set ftp:ssl-force true; set ftp:ssl-protect-data true; set ftp:ssl-auth TLS; set ssl:verify-certificate false; set ftps:initial-prot C;"
            while IFS= read -r path; do
              [ -z "$path" ] && continue
              printf 'rm -f "%s"\n' "$path"
            done < "$TMP_DELETE"
            echo "bye"
          } | lftp -u "$FTP_USER,$FTP_PASSWORD" -p "$FTP_PORT" "ftp://$FTP_HOST"

      - name: Normalize permissions after prune
        run: |
          TARGET_DIR="${{ github.event.inputs.remote_dir }}"
          if [ -z "$TARGET_DIR" ]; then TARGET_DIR="/public_html"; fi
          lftp -u "$FTP_USER,$FTP_PASSWORD" -p "$FTP_PORT" "ftp://$FTP_HOST" -e "set ftp:ssl-force true; set ftp:ssl-protect-data true; set ftp:ssl-auth TLS; set ssl:verify-certificate false; set ftps:initial-prot C; find $TARGET_DIR -type d -exec chmod 755 {}; find $TARGET_DIR -type f -exec chmod 644 {}; bye" || true
