name: FTP permissions normalize (manual)

on:
  workflow_dispatch:
    inputs:
      remote_dir:
        description: 'Remote directory to normalize (e.g., /public_html)'
        required: true
        default: '/public_html'
      use_ftps:
        description: 'Use FTPS (TLS) instead of plain FTP (true/false)'
        required: true
        default: 'true'

jobs:
  normalize:
    runs-on: ubuntu-latest
    env:
      FTP_HOST: ${{ secrets.FTP_HOST }}
      FTP_USER: ${{ secrets.FTP_USER }}
      FTP_PASSWORD: ${{ secrets.FTP_PASSWORD }}
      FTP_PORT: 990
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install tools
        run: |
          sudo apt-get update -y
          sudo apt-get install -y lftp

      - name: Set inputs
        run: |
          echo "REMOTE_DIR=${{ github.event.inputs.remote_dir }}" >> $GITHUB_ENV
          echo "USE_FTPS=${{ github.event.inputs.use_ftps }}" >> $GITHUB_ENV

      - name: Show current permissions (top level)
        run: |
          if [ "$USE_FTPS" = "true" ]; then
            TARGET="ftps://$FTP_HOST"; FLAGS="set ftp:ssl-force true; set ftp:ssl-protect-data true; set ssl:verify-certificate false; set ftps:initial-prot '';"
          else
            TARGET="ftp://$FTP_HOST"; FLAGS=""
          fi
          echo "Listing $REMOTE_DIR (first 100 entries with perms)"
          lftp -u "$FTP_USER,$FTP_PASSWORD" -p "$FTP_PORT" "$TARGET" -e "$FLAGS cls -l $REMOTE_DIR | head -100; bye" || true

      - name: Ensure directories are 755
        run: |
          set -euo pipefail
          if [ "$USE_FTPS" = "true" ]; then
            TARGET="ftps://$FTP_HOST"; FLAGS="set ftp:ssl-force true; set ftp:ssl-protect-data true; set ssl:verify-certificate false; set ftps:initial-prot '';"
          else
            TARGET="ftp://$FTP_HOST"; FLAGS=""
          fi
          echo "Collecting directory list recursively..."
          DIRS=$(lftp -u "$FTP_USER,$FTP_PASSWORD" -p "$FTP_PORT" "$TARGET" -e "$FLAGS find -d $REMOTE_DIR; bye" || true)
          echo "$DIRS" | sed 's/^/DIR: /'
          echo "$DIRS" | while IFS= read -r d; do
            [ -z "$d" ] && continue
            lftp -u "$FTP_USER,$FTP_PASSWORD" -p "$FTP_PORT" "$TARGET" -e "$FLAGS chmod 755 \"$d\"; bye" || true
          done

      - name: Set files to 644
        run: |
          set -euo pipefail
          if [ "$USE_FTPS" = "true" ]; then
            TARGET="ftps://$FTP_HOST"; FLAGS="set ftp:ssl-force true; set ftp:ssl-protect-data true; set ssl:verify-certificate false; set ftps:initial-prot '';"
          else
            TARGET="ftp://$FTP_HOST"; FLAGS=""
          fi
          echo "Collect all paths then subtract directories to get files..."
          ALL=$(lftp -u "$FTP_USER,$FTP_PASSWORD" -p "$FTP_PORT" "$TARGET" -e "$FLAGS find $REMOTE_DIR; bye" || true)
          DIRS=$(lftp -u "$FTP_USER,$FTP_PASSWORD" -p "$FTP_PORT" "$TARGET" -e "$FLAGS find -d $REMOTE_DIR; bye" || true)
          printf '%s\n' "$ALL" | grep -v '^$' | grep -Fvx -f <(printf '%s\n' "$DIRS") | while IFS= read -r f; do
            [ -z "$f" ] && continue
            lftp -u "$FTP_USER,$FTP_PASSWORD" -p "$FTP_PORT" "$TARGET" -e "$FLAGS chmod 644 \"$f\"; bye" || true
          done

      - name: Show permissions after
        run: |
          if [ "$USE_FTPS" = "true" ]; then
            TARGET="ftps://$FTP_HOST"; FLAGS="set ftp:ssl-force true; set ftp:ssl-protect-data true; set ssl:verify-certificate false; set ftps:initial-prot '';"
          else
            TARGET="ftp://$FTP_HOST"; FLAGS=""
          fi
          echo "Listing $REMOTE_DIR (first 100 entries with perms) AFTER"
          lftp -u "$FTP_USER,$FTP_PASSWORD" -p "$FTP_PORT" "$TARGET" -e "$FLAGS cls -l $REMOTE_DIR | head -100; bye" || true
