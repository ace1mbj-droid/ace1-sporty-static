name: Supabase Deploy (manual)

on:
  workflow_dispatch:
    inputs:
      confirm_production:
        description: "Type 'YES' to allow production deploy"
        required: true
        default: "NO"
      apply_migrations:
        description: "Apply DB migrations (supabase/migrations)"
        required: true
        default: "false"
      deploy_functions:
        description: "Deploy Edge Functions (create-order, webhook-razorpay, admin-reset)"
        required: true
        default: "true"

permissions:
  contents: read

jobs:
  deploy:
    runs-on: ubuntu-latest
    if: inputs.confirm_production == 'YES'

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Use Node
        uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: Install Supabase CLI
        run: npm install -g supabase@latest

      - name: Link project
        env:
          SUPABASE_ACCESS_TOKEN: ${{ secrets.SUPABASE_ACCESS_TOKEN }}
          SUPABASE_PROJECT_REF: ${{ secrets.SUPABASE_PROJECT_REF }}
        run: |
          if [ -z "$SUPABASE_ACCESS_TOKEN" ] || [ -z "$SUPABASE_PROJECT_REF" ]; then
            echo "Missing SUPABASE_ACCESS_TOKEN or SUPABASE_PROJECT_REF secrets."
            exit 1
          fi
          supabase link --project-ref "$SUPABASE_PROJECT_REF"

      - name: Apply migrations
        if: inputs.apply_migrations == 'true'
        env:
          SUPABASE_ACCESS_TOKEN: ${{ secrets.SUPABASE_ACCESS_TOKEN }}
        run: |
          supabase db push --yes

      - name: Deploy Edge Functions
        if: inputs.deploy_functions == 'true'
        env:
          SUPABASE_ACCESS_TOKEN: ${{ secrets.SUPABASE_ACCESS_TOKEN }}
          SUPABASE_PROJECT_REF: ${{ secrets.SUPABASE_PROJECT_REF }}
        run: |
          # Keep this list explicit to avoid accidentally deploying experimental dirs.
          supabase functions deploy create-order --project-ref "$SUPABASE_PROJECT_REF"
          supabase functions deploy webhook-razorpay --project-ref "$SUPABASE_PROJECT_REF"
          supabase functions deploy admin-reset --project-ref "$SUPABASE_PROJECT_REF"

# Required secrets:
# - SUPABASE_ACCESS_TOKEN
# - SUPABASE_PROJECT_REF
#
# Notes:
# - This workflow is MANUAL ONLY and guarded by confirm_production.
# - verify_jwt settings are tracked in supabase/functions/*/config.toml.
