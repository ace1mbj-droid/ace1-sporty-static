name: E2E — Supabase + Razorpay smoke test

on:
  workflow_dispatch: {}

jobs:
  e2e:
    runs-on: ubuntu-latest
    env:
      SUPABASE_PROJECT_REF: ${{ secrets.SUPABASE_PROJECT_REF }}
      SUPABASE_ANON_KEY: ${{ secrets.SUPABASE_ANON_KEY }}
      SUPABASE_DB_URL: ${{ secrets.SUPABASE_DB_URL }}
      SUPABASE_SERVICE_ROLE_KEY: ${{ secrets.SUPABASE_SERVICE_ROLE_KEY }}
      RZ_SECRET: ${{ secrets.RZ_SECRET }}
    steps:
      - uses: actions/checkout@v4

      - name: Use Node
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install system deps
        run: sudo apt-get update && sudo apt-get install -y jq postgresql-client openssl

      - name: Install deps
        run: |
          npm init -y
          npm i @supabase/supabase-js

      - name: Run E2E test script
        run: node ./scripts/e2e-test.js

      - name: Simulate Razorpay webhook (payment.captured)
        shell: bash
        env:
          RZ_SECRET: ${{ secrets.RZ_SECRET }}
          SUPABASE_PROJECT_REF: ${{ secrets.SUPABASE_PROJECT_REF }}
        run: |
          set -euo pipefail
          if [ ! -f /tmp/e2e-output.json ]; then
            echo "/tmp/e2e-output.json not found — create-order may have failed";
            exit 1;
          fi
          echo "Reading E2E output";
          cat /tmp/e2e-output.json
          RAZOR_ID=$(jq -r '.razorId // empty' /tmp/e2e-output.json)
          ORDER_ID=$(jq -r '.orderId // empty' /tmp/e2e-output.json)
          if [ -z "$RAZOR_ID" ]; then
            echo "No razor order id returned, skipping webhook simulation";
            exit 0;
          fi

          # Build a simple payment.captured payload
          PAYLOAD=$(jq -n --arg oid "$RAZOR_ID" '{ event: "payment.captured", payload: { payment: { entity: { order_id: $oid, id: ("pay_" + (now|tostring)), amount: 100 }}}}')

          # Compute HMAC-SHA256 signature as base64 (Razorpay uses this form in many examples)
          SIGNATURE=$(printf '%s' "$PAYLOAD" | openssl dgst -sha256 -hmac "$RZ_SECRET" -binary | openssl base64)

          echo "Posting webhook to functions endpoint"
          curl -sS -X POST "https://${{ secrets.SUPABASE_PROJECT_REF }}.functions.supabase.co/webhook-razorpay" \
            -H "Content-Type: application/json" \
            -H "x-razorpay-signature: $SIGNATURE" \
            --data-raw "$PAYLOAD" --fail -o /tmp/e2e-webhook-response.json || { echo "Webhook POST failed"; cat /tmp/e2e-webhook-response.json || true; exit 1; }
          echo "Webhook response:"; cat /tmp/e2e-webhook-response.json || true

      - name: Verify DB updates (service role)
        env:
          SUPABASE_PROJECT_REF: ${{ secrets.SUPABASE_PROJECT_REF }}
          SUPABASE_SERVICE_ROLE_KEY: ${{ secrets.SUPABASE_SERVICE_ROLE_KEY }}
        run: |
          set -euo pipefail
          if [ ! -f /tmp/e2e-output.json ]; then
            echo "/tmp/e2e-output.json missing — cannot verify DB without order id"; exit 1;
          fi
          node ./scripts/e2e-verify.js
