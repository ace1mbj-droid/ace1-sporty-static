name: FTPS Deploy (scheduled)

on:
  # Temporarily disabling scheduled runs; manual dispatch only
  workflow_dispatch:
    inputs:
      allowed_status_codes:
        description: 'Comma-separated HTTP codes treated as healthy'
        required: false
        default: '200,301,302,403'

jobs:
  deploy:
    runs-on: ubuntu-latest
    env:
      FTP_HOST: ${{ secrets.FTP_HOST }}
      FTP_USER: ${{ secrets.FTP_USER }}
      FTP_PASSWORD: ${{ secrets.FTP_PASSWORD }}
      FTP_PORT: 21
      DOMAIN: ${{ secrets.SITE_DOMAIN }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install lftp and curl
        run: |
          sudo apt-get update -y
          sudo apt-get install -y lftp curl

      - name: Build & copy to dist (exclude preview & test docs)
        run: |
          rm -rf dist || true
          mkdir -p dist
          rsync -av \
            --exclude='.git' \
            --exclude='.github' \
            --exclude='node_modules' \
            --exclude='dist' \
            --exclude='preview' \
            --exclude='docs/tests' \
            ./ dist/

      - name: Upload root via FTPS (mirror)
        run: |
          TARGET_DIR="/public_html/"
          echo "Deploying to $TARGET_DIR on $FTP_HOST"
          lftp -u "$FTP_USER,$FTP_PASSWORD" -p "$FTP_PORT" "ftp://$FTP_HOST" -e "set ftp:ssl-force true; set ftp:ssl-protect-data true; set ssl:verify-certificate false; set net:timeout 60; set net:max-retries 3; set net:reconnect-interval-base 5; mkdir -p $TARGET_DIR; mirror -R --parallel=2 --verbose --delete \
            --exclude-glob \"docs/tests/**\" \\
            --include-glob \"*.html\" \
            --include-glob \"*.css\" \
            --include-glob \"*.js\" \
            --include-glob \"*.json\" \
            --include-glob \"*.ico\" \
            --include-glob \"*.map\" \
            --include-glob \"*.png\" \
            --include-glob \"*.jpg\" \
            --include-glob \"*.jpeg\" \
            --include-glob \"*.gif\" \
            --include-glob \"*.svg\" \
            --include-glob \"*.webp\" \
            --include-glob \"*.avif\" \
            --include-glob \"*.woff\" \
            --include-glob \"*.woff2\" \
            --include-glob \"*.ttf\" \
            --include-glob \"*.otf\" \
            --include-glob \"*.eot\" \
            --exclude-glob \"*\" \
            dist $TARGET_DIR; bye"

      - name: Normalize permissions (dirs 755, files 644)
        run: |
          TARGET_DIR="/public_html/"
          lftp -u "$FTP_USER,$FTP_PASSWORD" -p "$FTP_PORT" "ftp://$FTP_HOST" -e "set ftp:ssl-force true; set ftp:ssl-protect-data true; set ssl:verify-certificate false; find -d $TARGET_DIR -type d -exec chmod 755 {}; find -d $TARGET_DIR -type f -exec chmod 644 {}; bye" || true

      - name: Health check via GET
        run: |
          if [ -z "$DOMAIN" ]; then echo "SITE_DOMAIN secret not set"; exit 0; fi
          echo "Checking https://$DOMAIN ..."
          STATUS=$(curl -s -o /dev/null -w "%{http_code}" "https://$DOMAIN")
          echo "HTTP status: $STATUS"
          curl -sI "https://$DOMAIN" || true
          ALLOWED="${{ github.event.inputs.allowed_status_codes }}"
          if [ -z "$ALLOWED" ]; then ALLOWED="200,301,302,403"; fi
          echo "Allowed status codes: $ALLOWED"
          PASS=false
          IFS=',' read -ra CODES <<< "$ALLOWED"
          for code in "${CODES[@]}"; do
            CLEAN_CODE=$(echo "$code" | xargs)
            if [ "$STATUS" = "$CLEAN_CODE" ]; then
              PASS=true
              break
            fi
          done
          if [ "$PASS" = true ]; then
            echo "Status $STATUS is allowed"
            exit 0
          else
            echo "Status $STATUS not in allowed list"
            exit 1
          fi
