name: FTPS Preview Deploy (manual)

on:
  workflow_dispatch:
    inputs:
      remote_dir:
        description: 'Remote preview directory'
        required: true
        default: '/public_html/preview/'

jobs:
  preview-deploy:
    runs-on: ubuntu-latest
    env:
      FTP_HOST: ${{ secrets.FTP_HOST }}
      FTP_USER: ${{ secrets.FTP_USER }}
      FTP_PASSWORD: ${{ secrets.FTP_PASSWORD }}
      FTP_PORT: 990
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install lftp
        run: |
          sudo apt-get update -y
          sudo apt-get install -y lftp

      - name: Build & copy to dist
        run: |
          rm -rf dist || true
          mkdir -p dist
          rsync -av --exclude='.git' --exclude='.github' --exclude='node_modules' --exclude='dist' ./ dist/

      - name: Upload preview via FTPS (clean upload)
        run: |
          TARGET_DIR="${{ github.event.inputs.remote_dir }}"
          if [ -z "$TARGET_DIR" ]; then TARGET_DIR="/public_html/preview/"; fi
          if [ ! -d dist ]; then echo "dist missing"; exit 1; fi
          echo "Deploying to $TARGET_DIR on $FTP_HOST"
          lftp -u "$FTP_USER,$FTP_PASSWORD" -p "$FTP_PORT" "ftps://$FTP_HOST" -e "set ftp:ssl-force true; set ftp:ssl-protect-data true; set ssl:verify-certificate false; set ftps:initial-prot ''; mkdir -p $TARGET_DIR; mirror -R --parallel=4 --verbose --delete \
            --exclude-glob .git \
            --exclude-glob .github \
            --exclude-glob .vscode \
            --exclude-glob node_modules \
            --exclude-glob dist \
            --exclude-glob docs \
            --exclude-glob tests \
            --exclude-glob "*.md" \
            --exclude-glob "*.map" \
            --exclude-glob "*.ts" \
            --exclude-glob "*.scss" \
            --exclude-glob "*.sass" \
            --exclude-glob "*.less" \
            --exclude-glob "*.psd" \
            --exclude-glob "*.ai" \
            --exclude-glob "*.sketch" \
            --exclude-glob ".DS_Store" \
            --exclude-glob "package.json" \
            --exclude-glob "package-lock.json" \
            --exclude-glob "pnpm-lock.yaml" \
            --exclude-glob "yarn.lock" \
            --exclude-glob "*.sh" \
            dist $TARGET_DIR; bye"

      - name: List preview directory (top 50)
        run: |
          TARGET_DIR="${{ github.event.inputs.remote_dir }}"
          if [ -z "$TARGET_DIR" ]; then TARGET_DIR="/public_html/preview/"; fi
          lftp -u "$FTP_USER,$FTP_PASSWORD" -p "$FTP_PORT" "ftps://$FTP_HOST" -e "set ftp:ssl-force true; set ftp:ssl-protect-data true; set ssl:verify-certificate false; set ftps:initial-prot ''; cls -l $TARGET_DIR | head -50; bye" || true
