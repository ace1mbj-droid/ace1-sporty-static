name: Apply admin_api_url migration

on:
  workflow_dispatch: {}

jobs:
  apply-migration:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install psql
        run: sudo apt-get update && sudo apt-get install -y postgresql-client

      - name: Apply migration SQL (safe parse)
        env:
          SUPABASE_DB_URL: ${{ secrets.SUPABASE_DB_URL }}
        run: |
          if [ -z "$SUPABASE_DB_URL" ]; then
            echo 'Missing SUPABASE_DB_URL secret; cannot apply migration.'
            exit 1
          fi
          echo 'Parsing SUPABASE_DB_URL and applying SQL using psql parameters (avoids malformed host parsing)'
          # Parse the DATABASE URL robustly using Python (handles query string / percent-encoding)
          echo "Parsing SUPABASE_DB_URL via python to extract components"
          parse_out=$(python - <<'PY'
import os
from urllib.parse import urlparse, unquote
u = os.getenv('SUPABASE_DB_URL')
if not u:
    print("__EMPTY__")
    raise SystemExit(1)
p = urlparse(u)
user = p.username or ''
password = p.password or ''
host = p.hostname or ''
port = p.port or 5432
dbname = (p.path or '').lstrip('/') or ''
print(user)
print(password)
print(host)
print(port)
print(dbname)
PY
)
          if [ -z "$parse_out" ] || [ "$parse_out" = "__EMPTY__" ]; then
            echo "Failed to parse SUPABASE_DB_URL (empty or invalid)"
            exit 1
          fi
          IFS=$'\n' read -r user pass host port db <<< "$parse_out"
          echo "Connecting to ${host}:${port} (db ${db}) as ${user}"
          PGPASSWORD="$pass" psql -h "$host" -p "$port" -U "$user" -d "$db" -c "ALTER TABLE IF EXISTS public.site_settings ADD COLUMN IF NOT EXISTS admin_api_url text;"
