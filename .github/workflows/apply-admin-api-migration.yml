name: Apply admin_api_url migration

on:
  workflow_dispatch: {}

jobs:
  apply-migration:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install psql
        run: sudo apt-get update && sudo apt-get install -y postgresql-client

      - name: Apply migration SQL (safe parse)
        env:
          SUPABASE_DB_URL: ${{ secrets.SUPABASE_DB_URL }}
        run: |
          if [ -z "$SUPABASE_DB_URL" ]; then
            echo 'Missing SUPABASE_DB_URL secret; cannot apply migration.'
            exit 1
          fi
          echo 'Parsing SUPABASE_DB_URL and applying SQL using psql parameters (avoids malformed host parsing)'
          # Parse the DATABASE URL and call psql with explicit flags (PGPASSWORD used for password)
          if ! [[ "$SUPABASE_DB_URL" =~ ^postgres://([^:]+):([^@]+)@([^:/]+):([0-9]+)/(.+)$ ]]; then
            echo "SUPABASE_DB_URL malformed or uses an unexpected format."
            exit 1
          fi
          user="${BASH_REMATCH[1]}"
          pass="${BASH_REMATCH[2]}"
          host="${BASH_REMATCH[3]}"
          port="${BASH_REMATCH[4]}"
          db="${BASH_REMATCH[5]}"
          echo "Connecting to ${host}:${port} (db ${db}) as ${user}"
          PGPASSWORD="$pass" psql -h "$host" -p "$port" -U "$user" -d "$db" -c "ALTER TABLE IF EXISTS public.site_settings ADD COLUMN IF NOT EXISTS admin_api_url text;"
