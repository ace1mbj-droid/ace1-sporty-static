name: Apply admin_api_url migration

on:
  workflow_dispatch: {}
  push:
    branches: [ main ]

jobs:
  apply-migration:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install psql
        run: sudo apt-get update && sudo apt-get install -y postgresql-client

      - name: Apply migration SQL (safe parse)
        env:
          SUPABASE_DB_URL: ${{ secrets.SUPABASE_DB_URL }}
        run: |
          if [ -z "$SUPABASE_DB_URL" ]; then
            echo 'Missing SUPABASE_DB_URL secret; cannot apply migration.'
            exit 1
          fi

          cat > /tmp/apply_admin_api_migration.py <<'PY'
#!/usr/bin/env python3
import os, subprocess, sys, time
from urllib.parse import urlparse, unquote

u = os.getenv('SUPABASE_DB_URL')
if not u:
    print('ERROR: SUPABASE_DB_URL empty')
    sys.exit(2)

p = urlparse(u)
user = unquote(p.username or '')
password = unquote(p.password or '')
host = p.hostname or ''
port = p.port or 5432
dbname = (p.path or '').lstrip('/') or ''

if not (host and dbname and user):
    print('ERROR: Failed to parse host/user/db from SUPABASE_DB_URL')
    print('url=', u)
    sys.exit(2)

sql = 'ALTER TABLE IF EXISTS public.site_settings ADD COLUMN IF NOT EXISTS admin_api_url text;'
env = dict(os.environ)
env['PGPASSWORD'] = password

max_attempts = 6
for attempt in range(1, max_attempts + 1):
  print(f'Attempt {attempt}/{max_attempts} - trying direct connection via URI')
  # Try direct connection with the full connection URL first (psql accepts a URI argument)
  rc = subprocess.call(['psql', u, '-c', sql], env=env)
    if rc == 0:
        print('Migration applied successfully')
        sys.exit(0)
    else:
    print(f'direct psql attempt returned {rc} — trying explicit host/port (fallback)')
    # fallback: explicit host/port/user/db invocation
    cmd = ['psql', '-h', host, '-p', str(port), '-U', user, '-d', dbname, '-c', sql]
    rc2 = subprocess.call(cmd, env=env)
    if rc2 == 0:
      print('Migration applied successfully (via fallback host/port)')
      sys.exit(0)
    print(f'fallback psql returned {rc2} — retrying after delay')
    time.sleep(attempt * 2)

print('All attempts failed — migration not applied')
sys.exit(3)
PY

          python /tmp/apply_admin_api_migration.py
