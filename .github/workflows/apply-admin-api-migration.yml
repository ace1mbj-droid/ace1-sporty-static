name: Apply admin_api_url migration

on:
  workflow_dispatch: {}
  push:
    branches: [ main ]

jobs:
  apply-migration:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install psql
        run: sudo apt-get update && sudo apt-get install -y postgresql-client

      - name: Apply migration SQL (safe parse)
        env:
          SUPABASE_DB_URL: ${{ secrets.SUPABASE_DB_URL }}
        run: |
          if [ -z "$SUPABASE_DB_URL" ]; then
            echo 'Missing SUPABASE_DB_URL secret; cannot apply migration.'
            exit 1
          fi

          echo "Debug: psql version"
          psql --version || true
          echo "Debug: python version"
          python --version || true
          
          # Print the parsed host/db (sanitized - avoid printing secrets). Wrap in try/except
          # so parsing errors won't fail the entire step.
          # Use a regex-based parse to avoid urlparse IPv6/format edge-cases
          python -c 'import os, re; u=os.getenv("SUPABASE_DB_URL") or ""; hosts=re.findall(r"@([^/:]+)", u); host=hosts[-1] if hosts else ""; db=(re.search(r"/([^/?#]+)(?:\?.*)?$", u) or [None])[1] if u else ""; print(f"DBG: host={host or "<missing>"} db={db or "<missing>"}")'

            cat > /tmp/apply_admin_api_migration.py <<'PY'
            #!/usr/bin/env python3
            import os, subprocess, sys, time
            from urllib.parse import unquote

            u = os.getenv('SUPABASE_DB_URL')
            if not u:
              print('ERROR: SUPABASE_DB_URL empty')
              sys.exit(2)

            # Robust parsing approach:
            # - split on '://' then take the rest
            # - split off the database name by rsplit('/', 1)
            # - split netloc on the last '@' (so passwords containing '@' are preserved)
            # - split host/port using rsplit(':', 1)
            rest = u.split('://', 1)[1] if '://' in u else u
            netloc_and_path = rest
            if '/' in rest:
              netloc, dbname = rest.rsplit('/', 1)
            else:
              netloc = rest
              dbname = ''

            if '@' in netloc:
              creds, hostport = netloc.rsplit('@', 1)
            else:
              creds = ''
              hostport = netloc

            # creds may be user[:password]
            if creds and ':' in creds:
              user, password = creds.split(':', 1)
            else:
              user = creds
              password = ''

            # hostport may be host[:port]
            if ':' in hostport:
              host, port = hostport.rsplit(':', 1)
              try:
                port = int(port)
              except Exception:
                port = 5432
            else:
              host = hostport
              port = 5432

            user = unquote(user or '')
            password = unquote(password or '')
            host = host or ''
            dbname = (dbname or '').lstrip('/') or ''

          if not (host and dbname and user):
              print('ERROR: Failed to parse host/user/db from SUPABASE_DB_URL')
              print('url=', u)
              sys.exit(2)

          sql = 'ALTER TABLE IF EXISTS public.site_settings ADD COLUMN IF NOT EXISTS admin_api_url text;'
          env = dict(os.environ)
          env['PGPASSWORD'] = password

          # Increase attempts and add verbose output to capture stdout/stderr for diagnostics
          max_attempts = 10
          for attempt in range(1, max_attempts + 1):
              print(f'Attempt {attempt}/{max_attempts} - trying direct connection via URI')
              # Try direct connection with the full connection URL first (psql accepts a URI argument)
              proc = subprocess.run(['psql', u, '-c', sql], env=env, capture_output=True, text=True)
              print('Direct attempt stdout:\n', proc.stdout)
              print('Direct attempt stderr:\n', proc.stderr)
              rc = proc.returncode
              if rc == 0:
                  print('Migration applied successfully (direct)')
                  sys.exit(0)

              print(f'direct psql attempt returned {rc} — trying explicit host/port (fallback)')
              # fallback: explicit host/port/user/db invocation
              cmd = ['psql', '-h', host, '-p', str(port), '-U', user, '-d', dbname, '-c', sql]
              proc2 = subprocess.run(cmd, env=env, capture_output=True, text=True)
              print('Fallback stdout:\n', proc2.stdout)
              print('Fallback stderr:\n', proc2.stderr)
              rc2 = proc2.returncode
              if rc2 == 0:
                  print('Migration applied successfully (via fallback host/port)')
                  sys.exit(0)

              print(f'Both attempts failed (direct={rc}, fallback={rc2}); retrying after backoff')
              # Exponential backoff plus a small jitter
              delay = attempt * 3 + (attempt % 3)
              time.sleep(delay)

          print('All attempts failed — migration not applied')
          sys.exit(3)
          PY

          # strip common indentation introduced by YAML heredoc (ensure valid python file)
          python -c "import textwrap, pathlib; p=pathlib.Path('/tmp/apply_admin_api_migration.py'); p.write_text(textwrap.dedent(p.read_text()))" || true

          python /tmp/apply_admin_api_migration.py > /tmp/apply_admin_api_migration.log 2>&1 || (
            echo 'Migration script returned non-zero; check /tmp/apply_admin_api_migration.log for details'
            echo '--- Last 200 lines of migration log ---'
            tail -n 200 /tmp/apply_admin_api_migration.log || true
            exit 1
          )

      - name: Upload migration logs
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: admin-api-migration-logs
          path: /tmp/apply_admin_api_migration.log
