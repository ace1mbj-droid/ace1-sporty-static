name: Apply admin_api_url migration

# Migration already applied manually - keeping workflow for reference only
# Can be triggered manually if needed in future
on:
  workflow_dispatch: {}

jobs:
  apply-migration:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install psql
        run: sudo apt-get update && sudo apt-get install -y postgresql-client

      - name: Apply migration SQL (safe parse)
        env:
          SUPABASE_DB_URL: ${{ secrets.SUPABASE_DB_URL }}
        run: |
          if [ -z "$SUPABASE_DB_URL" ]; then
            echo 'Missing SUPABASE_DB_URL secret; cannot apply migration.'
            exit 1
          fi

          echo "Debug: psql version"
          psql --version || true
          echo "Debug: python version"
          python --version || true
          
            # helper script will emit sanitized parse details (no inline python -c here)

          # Use a helper script that lives in .github/scripts to avoid YAML heredoc indentation pitfalls
          if [ -f .github/scripts/apply_admin_api_migration.py ]; then
            cp .github/scripts/apply_admin_api_migration.py /tmp/apply_admin_api_migration.py || true
          else
            echo 'ERROR: .github/scripts/apply_admin_api_migration.py is missing' > /tmp/apply_admin_api_migration.py
          fi

          # Print a preview of the generated file for debugging (safe: file contains no secrets)
          echo '--- Generated migration script (first 200 lines) ---'
          sed -n '1,200p' /tmp/apply_admin_api_migration.py || true

          python /tmp/apply_admin_api_migration.py > /tmp/apply_admin_api_migration.log 2>&1 || (
            echo 'Migration script returned non-zero; check /tmp/apply_admin_api_migration.log for details'
            echo '--- Last 200 lines of migration log ---'
            tail -n 200 /tmp/apply_admin_api_migration.log || true
            exit 1
          )

      - name: Upload migration logs
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: admin-api-migration-logs
          path: /tmp/apply_admin_api_migration.log
