name: Apply admin_api_url migration

on:
  workflow_dispatch: {}

jobs:
  apply-migration:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install psql
        run: sudo apt-get update && sudo apt-get install -y postgresql-client

      - name: Apply migration SQL (safe parse)
        env:
          SUPABASE_DB_URL: ${{ secrets.SUPABASE_DB_URL }}
        run: |
          if [ -z "$SUPABASE_DB_URL" ]; then
            echo 'Missing SUPABASE_DB_URL secret; cannot apply migration.'
            exit 1
          fi
          echo 'Parsing SUPABASE_DB_URL and applying SQL using psql parameters (avoids malformed host parsing)'
          python - <<'PY'
import os
from urllib.parse import urlparse
u = os.getenv('SUPABASE_DB_URL')
if not u:
    raise SystemExit('SUPABASE_DB_URL empty')
p = urlparse(u)
username = p.username
password = p.password
host = p.hostname
port = p.port or 5432
dbname = p.path.lstrip('/')
print('Connecting to', host, 'port', port, 'db', dbname)
import subprocess, sys
cmd = [
    'psql',
    '-h', host,
    '-p', str(port),
    '-U', username,
    '-d', dbname,
    '-c', "ALTER TABLE IF EXISTS public.site_settings ADD COLUMN IF NOT EXISTS admin_api_url text;"
]
env = dict(os.environ)
env['PGPASSWORD'] = password or ''
print('Running psql...')
rc = subprocess.call(cmd, env=env)
sys.exit(rc)
PY
