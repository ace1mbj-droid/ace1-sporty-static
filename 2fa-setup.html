<!DOCTYPE html>\n<html lang=\"en\">\n<head>\n  <meta charset=\"UTF-8\" />\n  <meta name=\"viewport\" content=\"width=device-width, initial-scale=1.0\" />\n  <title>2FA Setup - Ace#1</title>\n  <link rel=\"stylesheet\" href=\"css/style.css\" />\n  <style>\n    .setup-card { max-width: 520px; margin: 40px auto; padding: 24px; border-radius: 12px; background: #fff; box-shadow: 0 10px 30px rgba(0,0,0,0.08); }\n    .setup-card h1 { margin-bottom: 12px; }\n    .setup-card p { color: #666; font-size: 14px; margin: 0 0 16px 0; }\n    .methods { display: grid; gap: 12px; margin: 20px 0; }\n    .method-btn { padding: 16px; border: 2px solid #e5e7eb; border-radius: 8px; cursor: pointer; background: #fff; transition: all 0.2s; text-align: left; }\n    .method-btn:hover { border-color: #2a5298; background: #f7f9fc; }\n    .method-btn.active { border-color: #2a5298; background: #e8f0f8; }\n    .method-title { font-weight: 600; margin-bottom: 4px; }\n    .method-desc { font-size: 13px; color: #666; }\n    .code-input { width: 100%; padding: 12px; border: 1px solid #e5e7eb; border-radius: 8px; font-size: 16px; letter-spacing: 2px; text-align: center; font-family: monospace; margin: 16px 0; }\n    .btn { padding: 10px 14px; border: none; border-radius: 8px; cursor: pointer; font-weight: 600; }\n    .btn-primary { background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%); color: #fff; }\n    .btn-primary:disabled { opacity: 0.6; cursor: not-allowed; }\n    .btn-secondary { background: #f3f4f6; color: #111827; margin-right: 8px; }\n    .status { font-size: 13px; color: #374151; margin-top: 12px; }\n    .error { color: #b91c1c; }\n    .success { color: #065f46; }\n    .timer { font-size: 12px; color: #9ca3af; margin-top: 8px; }\n  </style>\n</head>\n<body>\n  <div class=\"setup-card\">\n    <h1>Set Up 2-Factor Authentication</h1>\n    <p>Secure your account with an additional verification step during login.</p>\n\n    <div class=\"methods\" id=\"methods\">\n      <div class=\"method-btn\" data-method=\"email\">\n        <div class=\"method-title\">üìß Email (Recommended)</div>\n        <div class=\"method-desc\">Get a 6-digit code sent to your email</div>\n      </div>\n      <div class=\"method-btn\" data-method=\"totp\">\n        <div class=\"method-title\">üîê Authenticator App</div>\n        <div class=\"method-desc\">Use an app like Google Authenticator</div>\n      </div>\n    </div>\n\n    <div id=\"emailSetup\" style=\"display: none;\">\n      <p style=\"margin-top: 16px;\">We'll send a verification code to your email.</p>\n      <button class=\"btn btn-primary\" id=\"sendCodeBtn\" style=\"width: 100%;\">Send Code to Email</button>\n      <div id=\"codeInputSection\" style=\"display: none; margin-top: 16px;\">\n        <input type=\"text\" class=\"code-input\" id=\"verificationCode\" placeholder=\"000000\" maxlength=\"6\" inputmode=\"numeric\" />\n        <div style=\"display: flex; gap: 8px;\">\n          <button class=\"btn btn-secondary\" id=\"cancelBtn\">Cancel</button>\n          <button class=\"btn btn-primary\" id=\"verifyCodeBtn\" style=\"flex: 1;\">Verify Code</button>\n        </div>\n        <div class=\"timer\">Code expires in <span id=\"timeLeft\">10:00</span></div>\n      </div>\n    </div>\n\n    <div id=\"totpSetup\" style=\"display: none;\">\n      <div style=\"text-align: center; padding: 20px 0;\">\n        <div id=\"qrBox\" style=\"background: #f7f9fc; padding: 16px; border-radius: 8px; display: inline-block;\">Loading QR Code...</div>\n      </div>\n      <div style=\"background: #111827; color: #e5e7eb; padding: 12px; border-radius: 8px; margin: 16px 0; word-break: break-all; font-family: monospace; font-size: 12px;\" id=\"secretBox\">‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢</div>\n      <p style=\"font-size: 12px; color: #666;\">1. Scan the QR code with your authenticator app or enter the secret key manually.</p>\n      <button class=\"btn btn-primary\" id=\"enableTotpBtn\" style=\"width: 100%; margin-top: 16px;\">Enable Authenticator</button>\n    </div>\n\n    <div class=\"status\" id=\"statusMsg\"></div>\n  </div>\n\n  <script>\n    const methods = document.querySelectorAll('.method-btn');\n    const emailSetup = document.getElementById('emailSetup');\n    const totpSetup = document.getElementById('totpSetup');\n    const sendCodeBtn = document.getElementById('sendCodeBtn');\n    const verifyCodeBtn = document.getElementById('verifyCodeBtn');\n    const cancelBtn = document.getElementById('cancelBtn');\n    const codeInputSection = document.getElementById('codeInputSection');\n    const verificationCode = document.getElementById('verificationCode');\n    const statusMsg = document.getElementById('statusMsg');\n    const qrBox = document.getElementById('qrBox');\n    const secretBox = document.getElementById('secretBox');\n    const enableTotpBtn = document.getElementById('enableTotpBtn');\n    const timeLeftSpan = document.getElementById('timeLeft');\n\n    let selectedMethod = 'email';\n    let codeExpireTime = 0;\n    let userId = null;\n\n    // Get user ID from session/auth\n    async function getUserId() {\n      try {\n        const res = await fetch('https://vorqavsuqcjnkjzwkyzr.supabase.co/auth/v1/user', {\n          headers: { 'Authorization': `Bearer ${localStorage.getItem('sb-token') || ''}` }\n        });\n        if (res.ok) {\n          const user = await res.json();\n          return user.id;\n        }\n      } catch (err) {\n        console.warn('Could not get user ID', err);\n      }\n      return null;\n    }\n\n    methods.forEach(method => {\n      method.addEventListener('click', () => {\n        methods.forEach(m => m.classList.remove('active'));\n        method.classList.add('active');\n        selectedMethod = method.dataset.method;\n\n        if (selectedMethod === 'email') {\n          emailSetup.style.display = 'block';\n          totpSetup.style.display = 'none';\n        } else {\n          emailSetup.style.display = 'none';\n          totpSetup.style.display = 'block';\n          loadTotpSetup();\n        }\n      });\n    });\n\n    // Email 2FA flow\n    sendCodeBtn.addEventListener('click', async () => {\n      userId = await getUserId();\n      if (!userId) {\n        setStatus('Could not identify user session', false, true);\n        return;\n      }\n\n      sendCodeBtn.disabled = true;\n      setStatus('Sending code...', false);\n\n      try {\n        const token = localStorage.getItem('sb-token') || '';\n        const userEmail = JSON.parse(localStorage.getItem('sb-user') || '{}').email;\n\n        const res = await fetch('https://vorqavsuqcjnkjzwkyzr.supabase.co/functions/v1/send-2fa-code', {\n          method: 'POST',\n          headers: {\n            'Authorization': `Bearer ${token}`,\n            'Content-Type': 'application/json'\n          },\n          body: JSON.stringify({\n            userId,\n            email: userEmail\n          })\n        });\n\n        if (res.ok) {\n          const body = await res.json();\n          codeExpireTime = new Date(body.expiresAt).getTime();\n          startTimer();\n          codeInputSection.style.display = 'block';\n          setStatus('Code sent! Check your email.', true);\n          verificationCode.focus();\n        } else {\n          setStatus('Failed to send code', false, true);\n        }\n      } catch (err) {\n        setStatus(err.message || 'Error sending code', false, true);\n      } finally {\n        sendCodeBtn.disabled = false;\n      }\n    });\n\n    verifyCodeBtn.addEventListener('click', async () => {\n      const code = verificationCode.value.trim();\n      if (code.length !== 6) {\n        setStatus('Code must be 6 digits', false, true);\n        return;\n      }\n\n      verifyCodeBtn.disabled = true;\n      setStatus('Verifying...', false);\n\n      try {\n        const token = localStorage.getItem('sb-token') || '';\n        const res = await fetch('https://vorqavsuqcjnkjzwkyzr.supabase.co/functions/v1/verify-user-2fa', {\n          method: 'POST',\n          headers: {\n            'Authorization': `Bearer ${token}`,\n            'Content-Type': 'application/json'\n          },\n          body: JSON.stringify({ userId, code })\n        });\n\n        if (res.ok) {\n          setStatus('2FA enabled! Redirecting...', true);\n          setTimeout(() => { window.location.href = 'dashboard.html'; }, 1500);\n        } else {\n          const err = await res.json();\n          setStatus(err.error || 'Invalid code', false, true);\n        }\n      } catch (err) {\n        setStatus(err.message || 'Verification failed', false, true);\n      } finally {\n        verifyCodeBtn.disabled = false;\n      }\n    });\n\n    cancelBtn.addEventListener('click', () => {\n      codeInputSection.style.display = 'none';\n      verificationCode.value = '';\n      setStatus('Cancelled', false);\n    });\n\n    function startTimer() {\n      const interval = setInterval(() => {\n        const now = Date.now();\n        const remaining = Math.max(0, codeExpireTime - now);\n        const minutes = Math.floor(remaining / 60000);\n        const seconds = Math.floor((remaining % 60000) / 1000);\n        timeLeftSpan.textContent = `${minutes}:${seconds.toString().padStart(2, '0')}`;\n\n        if (remaining <= 0) {\n          clearInterval(interval);\n          sendCodeBtn.disabled = false;\n          codeInputSection.style.display = 'none';\n          setStatus('Code expired. Send a new one.', false, true);\n        }\n      }, 1000);\n    }\n\n    async function loadTotpSetup() {\n      try {\n        const token = localStorage.getItem('sb-token') || '';\n        const res = await fetch('https://vorqavsuqcjnkjzwkyzr.supabase.co/functions/v1/admin-totp-active', {\n          headers: { 'Authorization': `Bearer ${token}` }\n        });\n\n        if (res.ok) {\n          const body = await res.json();\n          qrBox.innerHTML = `<img src=\"${body.qrDataUrl}\" alt=\"TOTP QR\" style=\"width: 220px; height: 220px;\" />`;\n          secretBox.textContent = body.secret;\n        }\n      } catch (err) {\n        qrBox.textContent = 'Failed to load QR code';\n      }\n    }\n\n    enableTotpBtn.addEventListener('click', () => {\n      setStatus('Authenticator app enabled! Redirecting...', true);\n      setTimeout(() => { window.location.href = 'dashboard.html'; }, 1500);\n    });\n\n    function setStatus(msg, success = false, isError = false) {\n      statusMsg.textContent = msg;\n      statusMsg.className = 'status' + (success ? ' success' : '') + (isError ? ' error' : '');\n    }\n\n    // Select email by default\n    methods[0].click();\n  </script>\n</body>\n</html>\n