import \"jsr:@supabase/functions-js/edge-runtime.d.ts\";\nimport { createClient } from \"jsr:@supabase/supabase-js@2\";\n\nconst SUPABASE_URL = Deno.env.get(\"SUPABASE_URL\");\nconst SUPABASE_SERVICE_ROLE_KEY = Deno.env.get(\"SUPABASE_SERVICE_ROLE_KEY\");\n\nDeno.serve(async (req: Request) => {\n  // CORS\n  if (req.method === \"OPTIONS\") {\n    return new Response(\"ok\", {\n      headers: {\n        \"Access-Control-Allow-Origin\": \"*\",\n        \"Access-Control-Allow-Methods\": \"POST, OPTIONS\",\n        \"Access-Control-Allow-Headers\": \"authorization, content-type\",\n      },\n    });\n  }\n\n  try {\n    const authHeader = req.headers.get(\"Authorization\");\n    if (!authHeader || !authHeader.startsWith(\"Bearer \")) {\n      return new Response(\n        JSON.stringify({ error: \"Unauthorized\" }),\n        { status: 401, headers: { \"Content-Type\": \"application/json\", \"Access-Control-Allow-Origin\": \"*\" } }\n      );\n    }\n\n    const { userId, code } = await req.json().catch(() => ({}));\n\n    if (!userId || !code) {\n      return new Response(\n        JSON.stringify({ error: \"Missing userId or code\" }),\n        { status: 400, headers: { \"Content-Type\": \"application/json\", \"Access-Control-Allow-Origin\": \"*\" } }\n      );\n    }\n\n    const supabase = createClient(SUPABASE_URL!, SUPABASE_SERVICE_ROLE_KEY!);\n\n    // Find valid, non-expired, unused 2FA code for user\n    const { data, error } = await supabase\n      .from(\"user_2fa_codes\")\n      .select(\"id, code, expires_at, verified\")\n      .eq(\"user_id\", userId)\n      .eq(\"verified\", false)\n      .gt(\"expires_at\", new Date().toISOString())\n      .order(\"created_at\", { ascending: false })\n      .limit(1)\n      .single();\n\n    if (error || !data) {\n      return new Response(\n        JSON.stringify({ error: \"No valid 2FA code found\" }),\n        { status: 404, headers: { \"Content-Type\": \"application/json\", \"Access-Control-Allow-Origin\": \"*\" } }\n      );\n    }\n\n    // Verify code matches\n    if (data.code !== code.trim()) {\n      return new Response(\n        JSON.stringify({ error: \"Invalid code\" }),\n        { status: 401, headers: { \"Content-Type\": \"application/json\", \"Access-Control-Allow-Origin\": \"*\" } }\n      );\n    }\n\n    // Mark code as verified\n    const { error: updateError } = await supabase\n      .from(\"user_2fa_codes\")\n      .update({ verified: true })\n      .eq(\"id\", data.id);\n\n    if (updateError) {\n      throw updateError;\n    }\n\n    return new Response(\n      JSON.stringify({\n        success: true,\n        message: \"2FA verified successfully\",\n      }),\n      {\n        status: 200,\n        headers: {\n          \"Content-Type\": \"application/json\",\n          \"Access-Control-Allow-Origin\": \"*\",\n        },\n      }\n    );\n  } catch (error) {\n    console.error(\"Error:\", error);\n    return new Response(\n      JSON.stringify({ error: \"Server error\" }),\n      { status: 500, headers: { \"Content-Type\": \"application/json\", \"Access-Control-Allow-Origin\": \"*\" } }\n    );\n  }\n});\n